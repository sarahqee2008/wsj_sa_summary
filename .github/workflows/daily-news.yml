name: Daily News Update

on:
  schedule:
    # 10:00 AM ET = 15:00 UTC (EST) / 14:00 UTC (EDT)
    - cron: '0 15 * * 1-5'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-news:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run news update
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: bash update.sh

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "NEWS_UPDATED=false" >> $GITHUB_ENV
          else
            COMMIT_DATE="$(date -u +'%Y-%m-%d')"
            git commit -m "Daily news update: ${COMMIT_DATE}"
            git push
            echo "NEWS_UPDATED=true" >> $GITHUB_ENV
            echo "UPDATE_DATE=${COMMIT_DATE}" >> $GITHUB_ENV
          fi

      - name: Send email notification
        if: env.NEWS_UPDATED == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "Guaiguai News ${{ env.UPDATE_DATE }}"
          to: sarah.qee2008@gmail.com
          from: ${{ secrets.GMAIL_USERNAME }}
          html_body: |
            <div style="font-family: -apple-system, Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
              <h2 style="color: #1a1a2e;">üóûÔ∏è Guaiguai News ${{ env.UPDATE_DATE }}</h2>
              <p style="color: #444; font-size: 15px; line-height: 1.6;">
                Today's financial news dashboard has been updated with the latest articles from
                <strong>MarketWatch</strong>, <strong>Barron's</strong>, <strong>Seeking Alpha</strong>,
                and <strong>The Insurer</strong>.
              </p>
              <p style="margin: 24px 0;">
                <a href="https://sarahqee2008.github.io/wsj_sa_summary/"
                   style="background: #388bfd; color: white; padding: 12px 28px; border-radius: 8px;
                          text-decoration: none; font-weight: 600; font-size: 15px;">
                  üìñ View Today's News Dashboard
                </a>
              </p>
              <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 24px 0;">
              <p style="color: #888; font-size: 12px;">
                This is an automated notification from your Guaiguai News dashboard.<br>
                Live market data is available on the page via TradingView widgets.
              </p>
            </div>
